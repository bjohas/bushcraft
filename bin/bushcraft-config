#!/usr/bin/perl

$conf = "$ENV{HOME}/.config/bushcraft/";
chdir();

if ($ARGV[0] eq "") {
    print "Usage:
$0 <base url for config files>

or

$0 -r 

to reuse.
";
    exit;
};

if ($ARGV[0] eq "-c") {
    print "Removing: $conf/source.cfg\n";
    system("rm","$conf/source.cfg");
    exit;
};
if ($ARGV[0] ne "-m") {
    if ($ARGV[0] eq "-r" || $ARGV[0] eq "")  {
	
	if ( -e "$conf/source.cfg") {
	    open F,"$conf/source.cfg";
	    while (<F>) {
		if (m/^base\=(.*)$/) {
		    $url = $1;
		};
	    };
	    close F;
	} else {
	    print "Sorry, config file $conf/source.cfg not found\n";
	    exit;
	};
	
    } else {
	
	$url = $ARGV[0];
	print "Updating $conf/source.cfg\n";
	open F,">$conf/source.cfg";
	print F "base=$url\n";
	close F;
    };
    
    $url =~ s/\n//;
    
    chdir();
    opendir(my $dh, "$ENV{HOME}/bushcraft/config") || die;
    while(readdir $dh) {
	next if m/^(\.|\.\.)$/;
	next if !-f "$ENV{HOME}/bushcraft/config/$_";
	print "Fetching $_\n";
	system "wget -q -O $conf/temp.txt $url/$_";
	if (-e "$conf/temp.txt" && !-z "$conf/temp.txt") {
	    print "- Updating $_\n\n";
	    system("mv","$conf/temp.txt","$conf/$_");
	} else {
#	    print "- ...  $_\n\n";
	};
	if (-e "$conf/temp.txt") {
	    system("rm","$conf/temp.txt");
	};
    };
    closedir $dh;
    
} else {

    chdir();
    opendir(my $dh, "$ENV{HOME}/bushcraft/config") || die;
    while(readdir $dh) {
	print "Manual config: $_\n";
# open the preset config file, and then let the user enter values.
	print "Not implemented\n";
    };
    closedir $dh;

};
